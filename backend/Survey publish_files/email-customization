var Webropol=Webropol||{},defaultPopoverOptions,Component;Webropol.Common=Webropol.Common||{};Webropol.Common.CustomizeEmail=function(n,t){var i=n;t.customizedSenderNameCache={};t.customizedSenderNameImmediate=ko.observable(null);t.isCustomizedSenderNameImmediateEmpty=function(){return t.customizedSenderNameImmediate()===i.customizedSenderNamePlaceholder||!t.customizedSenderNameImmediate()?!0:!1};t.getCustomizedSenderName=function(n,i){return i()===n.Email()?t.customizedSenderNameImmediate():t.customizedSenderNameCache[n.Email()]||""};t.SelectedFrom.subscribe(function(n){t.customizedSenderNameCache[n]=t.CustomizedSenderName()},null,"beforeChange");t.forcePlaceholder=function(){$(".js-customized-sender-name").trigger("focus.placeholder");$(".js-customized-sender-name").trigger("blur.placeholder")};t.updateCustomizedSenderName=function(){if(t.customizedSenderNameImmediate($.trim(t.customizedSenderNameImmediate())),t.isCustomizedSenderNameImmediateEmpty()){t.CustomizedSenderName("");return}t.CustomizedSenderName(t.customizedSenderNameImmediate())};t.clearCustomizedSenderName=function(){t.customizedSenderNameImmediate("");t.updateCustomizedSenderName()};t.restoreCustomizedSenderNameFromCache=function(n){var i=t.customizedSenderNameCache[n];i?(t.customizedSenderNameImmediate(i),t.CustomizedSenderName(i)):(t.customizedSenderNameImmediate(""),t.CustomizedSenderName(""),t.forcePlaceholder())};t.extendFromOptions=function(n,r){for(var u=0;u<n.length;u++)(function(n){n.TextComputed=ko.computed(function(){var u=t.getCustomizedSenderName(n,t.SelectedFrom);return u?n.Email()===r?Webropol.Shared.Common.stringFormat("{0} {1} {2}",u,i.via,n.Text()):Webropol.Shared.Common.stringFormat("{0} <{1}>",u,n.Text()):n.Text()})})(n[u])};t.extendReplyOptions=function(n){for(var i=0;i<n.length;i++)(function(n){n.TextComputed=ko.computed(function(){return t.SelectedReplyTo()!==n.Email()||n.Email()===""||t.isCustomizedSenderNameImmediateEmpty()?n.Text():Webropol.Shared.Common.stringFormat("{0} <{1}>",t.customizedSenderNameImmediate(),n.Text())})})(n[i])};t.onSelectEmailTag=function(n){t.IncludeRecipientLoginAndPassword()||n!==Webropol.Constants.Common.Tag.USER_NAME&&n!==Webropol.Constants.Common.Tag.USER_PASSWORD||t.IncludeRecipientLoginAndPassword(!0)};t.onIncludeRecipientLoginAndPassword=function(){if(t.IncludeRecipientLoginAndPassword()){var n=t.EmailBody(),r=Webropol.Shared.Common.stringFormat("<b>{0}:<\/b> {1}<br/><b>{2}:<\/b> {3}",i.userName,Webropol.Constants.Common.Tag.USER_NAME,i.userPassword,Webropol.Constants.Common.Tag.USER_PASSWORD);n?n+="<br/>"+r:n=r;t.EmailBody(n)}return!0}};Webropol=Webropol||{};Webropol.Common=Webropol.Common||{};Webropol.Common.EmailTemplate=function(n,t){var i=n;t.selectedEmailTemplate=ko.observable(null);t.emailTemplateWasChanged=ko.observable(!1);t.emailTemplateWasSaved=ko.observable(!1);t.GetEmailTemplateGroups=function(){throw"Method not implemented";};t.onEmailTemplateChanged=function(n){var f,r,e,u,i;for(t.emailTemplateWasChanged.valueHasMutated(),f=t.GetEmailTemplateGroups(),r=0;r<f.length;++r)for(e=f[r],u=0;u<e.EmailTemplates().length;++u){if(i=e.EmailTemplates()[u],i.EmailTemplateId()==n){t.EmailSubject(i.Subject());t.EmailBody(i.Body());t.selectedEmailTemplate(i);return}t.selectedEmailTemplate(null)}}};Webropol=Webropol||{};Webropol.Common=Webropol.Common||{};Webropol.Common.EmailTemplateSaver=function(n){var t=this,r=n,i;this.isAttachedFiles=t.isAttachedFiles||ko.observable(!1);this.SavingTemplateName=ko.observable("");this.Attachments=t.Attachments||ko.observableArray([]);this.emailTemplateAttachments=ko.observableArray(t.EmailTemplateAttachments);i=function(n){for(var u,r,f,i=0;i<t.EmailTemplateGroups().length;++i)for(u=t.EmailTemplateGroups()[i],r=0;r<u.EmailTemplates().length;++r)if(f=u.EmailTemplates()[r],n(f))return f;return null};this.getSendAttachedFilesForm=function(){var n=$(".js-send-attached-files")[0];return n||(n=$(".js-upload-attached-files-on-edit-form")[0]),n.action=r.uploadAttachedFiles,n};this.getSendingViewModel=function(){var i=ko.utils.arrayMap(t.emailTemplateAttachments(),function(n){return n.FileName}),r=i.concat(t.AttachedFileNames()||[]),n=ko.mapping.toJS(t,{ignore:["EmailTemplateGroups","EmptyReplyTo","FromForManual","ReplyTo","ReplyToForManual","SslLink","To","WebropolEmail","From","EmailRecipientsCount",]});return n.AttachedFileNames=r,n};this.showEmailSavingDialog=function(){var n=null;t.SelectedEmailTemplateId()!==Webropol.Shared.Common.guidEmpty&&(n=t.getTemplateById(t.SelectedEmailTemplateId()));t.SavingTemplateName(n?n.Name():null);ko.shared.showPopupFromTemplate("emailtemplate-save-template",t)};this.showQRsampleDailog=function(){ko.shared.showPopupFromTemplate("event-qr-priview-template",t)};var f=function(){return t.emailTemplateAttachments()&&t.emailTemplateAttachments().length||t.Attachments()&&t.Attachments().length},e=function(n){var r=ko.utils.arrayMap(t.emailTemplateAttachments(),function(n){return n.FileName}),i,u;return t.Attachments&&t.Attachments().length?(u=ko.utils.arrayMap(t.Attachments(),function(n){return n.FileName()}),i=r.concat(u)):i=r,i.concat(n)},u=function(n,i,u,f){var o={Name:t.SavingTemplateName(),Subject:t.EmailSubject(),Body:t.EmailBody(),AttachedFileNames:n},e=t.getTemplateByName(t.SavingTemplateName());e&&(o.EmailTemplateId=e.EmailTemplateId());Webropol.Shared.Common.callAsync(ko.mapping.toJSON(o),r.saveEmailTemplate,function(n){var r,u,f;if(Webropol.Common.showSuccessMessage(n),typeof i=="function"&&i(),t.emailTemplateWasSaved.valueHasMutated(),e&&t.SelectedEmailTemplateId()===e.EmailTemplateId()&&t.emailTemplateAttachments(n.ExtraData.Attachments),r=ko.mapping.fromJS(n.ExtraData),e)e.Subject(r.Subject()),e.Body(r.Body());else for(u=0;u<t.EmailTemplateGroups().length;++u)if(f=t.EmailTemplateGroups()[u],f.AccessLevel()==0){f.EmailTemplates.push(r);f.EmailTemplates.sort(function(n,t){return n.Name()==t.Name()?0:n.Name()<t.Name()?-1:1});t.SelectedEmailTemplateId(r.EmailTemplateId());return}},u,null,f)},o=function(n){var i=t.getSendAttachedFilesForm(),f=function(){typeof onSuccess=="function"&&onSuccess();n.resolve()},r=function(){n.reject()},o=function(n){var t=JSON.parse(n),i=t.attachedFileNames,o=e(i);u(o,f,r,!0)};Webropol.Shared.Common.callAjaxSubmit($(i),{url:i.action,success:o,error:r},!0)};this.saveEmailTemplate=function(){t.isAttachedFiles()||f()?Webropol.Shared.Common.callMultipleAjax(o):u(null,null,null,!1)};this.getTemplateByName=function(n){return i(function(t){return t.Name()===n})};this.getTemplateById=function(n){return i(function(t){return t.EmailTemplateId()===n})}};Component=Component||{};defaultPopoverOptions={placement:"top",container:".email-body:visible"};Component.AddEmailTag=function(n){function t(n,t){this.emailBody=n.emailBody;this.ckeditorInstance=n.ckeditorInstance;this.tags=ko.unwrap(n.tags);this.onSelect=n.onSelect;this.popoverOptions=$.extend({},defaultPopoverOptions,n.popoverOptions);this.isFirefox=Webropol.Shared.Common.browser.isFirefox();this.initPopover=function(){$(t).find('[data-toggle="popover"]').popover({sanitize:!1})}}return t.prototype.addTagToEmailBody=function(n){var t=this,i=n.Tag(),r;if(Webropol.Shared.Common.insertTextToEditor(t.ckeditorInstance(),i)||(r=t.emailBody()||"",t.emailBody(r+i)),typeof t.onSelect=="function")t.onSelect(i)},this.registerComponent=function(){ko.components.register("add-email-tag",{viewModel:{createViewModel:function(n,i){var r=i.element;return new t(n,r)}},template:{element:n}})},this};Component=Component||{};Component.EmailAttachments=function(n,t){function i(n,t){var i=this;this.files=ko.observableArray([]);this.sizeLimitInBytes=n.sizeLimitInMb?n.sizeLimitInMb*1048576:null;this.sizeLimitInMb=n.sizeLimitInMb;this.attachmentsSizeExceeded=n.attachmentsSizeExceeded||ko.observable(!1);this.isAttachedFiles=n.isAttachedFiles||ko.observable(!1);this.allowedFileFormats=n.allowedFileFormats?n.allowedFileFormats.split(", "):[];this.allowedFileFormatsStr=n.allowedFileFormats?n.allowedFileFormats:"";this.emailTemplateAttachments=n.emailTemplateAttachments||ko.observableArray([]);this.emailTemplateWasChanged=n.emailTemplateWasChanged||ko.observable();this.emailTemplateWasSaved=n.emailTemplateWasSaved||ko.observable();this.savedEmailAttachments=n.savedEmailAttachments||ko.observableArray([]);this.externalForm=n.externalForm||null;this.element=t;n.attachmentLimitMessage&&this.sizeLimitInMb?this.attachmentLimitMessage=r(n.attachmentLimitMessage,this.sizeLimitInMb):this.sizeLimitInMb&&(this.attachmentLimitMessage=r(u.attachmentLimitMessage,this.sizeLimitInMb));this.attachmentLimitExceededMessage=n.attachmentLimitExceededMessage||u.attachmentLimitExceededMessage;this.formInputName=n.formInputName||"attachedFiles";this.formatError=ko.observable("");i._initializeComputed();i._initializeSubscriptions()}var u=t,r=Webropol.Shared.Common.stringFormat;return i.prototype._initializeComputed=function(){var n=this;ko.computed(function(){n.emailTemplateAttachments();n.attachmentsSizeExceeded(n.isAttachmentsSizeExceeded())})},i.prototype._initializeSubscriptions=function(){var n=this,t=function(){var i,r,t,u;for(i=n.externalForm?$(n.externalForm):$(n.element).find(".js-email-attachments"),r=n.files.peek(),t=r.length-1;t>=0;t--)u=n.files()[t],n.removeFileFrom(t,u,i)};n.emailTemplateWasSaved.subscribe(t);n.emailTemplateWasChanged.subscribe(t)},i.prototype.addFile=function(n,t){var r=t.target.files[0],e=t.target,u=$(t.target).closest(".js-email-attachments"),i;if(this.allowedFileFormats.length>0){var o=r.name.split("."),s=o[o.length-1],f=!1;if(s)for(i=0;i<this.allowedFileFormats.length;i++)this.allowedFileFormats[i]===s&&(f=!0);else f=!0;if(f)this.hideFormatError();else{this.showFormatError(r.name);this.createNewInputForm(u);$(e).remove();return}}this.files.push(r);this.attachmentsSizeExceeded(this.isAttachmentsSizeExceeded());this.isAttachedFiles(!0);this.moveInputToList(e,u);this.createNewInputForm(u)},i.prototype.showFormatError=function(){this.formatError(r(u.invalidFileFormat,this.allowedFileFormatsStr))},i.prototype.hideFormatError=function(){this.formatError("")},i.prototype.moveInputToList=function(n,t){if(n.name=r("{0}[{1}]",this.formInputName,this.files().length-1),$(n).addClass("not-visible-file-inputs"),this.externalForm){var i=$(this.externalForm);i[0].appendChild(n);return}$(".js-attach-file-list",t)[0].appendChild(n)},i.prototype.createNewInputForm=function(n){var t=document.createElement("input");t.type="file";$(t).on("change",this.addFile.bind(this,this));$(".js-attach-file",n)[0].appendChild(t)},i.prototype.removeFile=function(n,t,i){var r;r=this.externalForm?$(this.externalForm):$(i.target).closest(".js-email-attachments");this.removeFileFrom(n(),t,r)},i.prototype.removeFileFrom=function(n,t,i){this.revokeFileUrl(t);this.files.remove(t);this.attachmentsSizeExceeded(this.isAttachmentsSizeExceeded());this.files.length||this.isAttachedFiles(!1);$(r('[name="{0}[{1}]"]',this.formInputName,n),i).remove();$(r('[name^="{0}"]',this.formInputName),i).each(function(n,t){t.name=r("{0}[{1}]",this.formInputName,n)}.bind(this))},i.prototype.getFileUrl=function(n){return window.URL?window.URL.createObjectURL(n):"#"},i.prototype.revokeFileUrl=function(n){window.URL&&window.URL.revokeObjectURL(n)},i.prototype.isAttachmentsSizeExceeded=function(){var n=0;return $.each(this.files(),function(t,i){n+=i.size}),ko.utils.arrayForEach(this.emailTemplateAttachments(),function(t){n+=t.FileSize}),this.sizeLimitInBytes&&n>this.sizeLimitInBytes},i.prototype.removeTemplateAttachment=function(n,t){this.emailTemplateAttachments.remove(t)},i.prototype.removeSavedEmailAttachment=function(n,t){this.savedEmailAttachments.remove(t)},this.registerComponent=function(){ko.components.register("email-attachments",{viewModel:{createViewModel:function(n,t){var r=t.element;return new i(n,r)}},template:{element:n}})},this};Component=Component||{};Component.InsertImageInEmail=function(n){return this.registerComponent=function(){ko.components.register("insert-image-in-email",{viewModel:function(n){var t=this,i;this.emailBody=n.emailBody;this.buttonText=n.buttonText;this.showImageGallery=n.showImageGallery;this.imageGalleryMode=n.imageGalleryMode||Webropol.Constants.ImageGalleryMode.InsertIntoEmail;this.ckeditorInstance=n.ckeditorInstance;this.isFirefox=Webropol.Shared.Common.browser.isFirefox();i=function(n){return location.protocol+"//"+location.host+n};this.insertImage=function(){var n=function(n){var r='<img src="'+i(n.ImagePath())+'" alt=""/>',u;Webropol.Shared.Common.insertTextToEditor(t.ckeditorInstance(),r)||(u=t.emailBody()||"",t.emailBody(u+r))};t.showImageGallery(t.imageGalleryMode,n)}},template:{element:n}})},this}