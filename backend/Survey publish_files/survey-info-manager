var Webropol=Webropol||{};Webropol.Survey=Webropol.Survey||{};Webropol.Survey.SurveyInfoManager=function(n,t){var i=this,u=n,e=t,r,f;i.SurveyId=null;i.SurveyInfo=null;i.ForceClickOnRights=!1;i.modalTemplateId="survey-info-template";i.needToLoadHistory=!0;r=null;f=function(){i.surveyInfoClone=new Webropol.Survey.SurveyInfoManager.SurveyInfo(u,e,i);i.surveyInfoClone.init(ko.mapping.toJS(i.SurveyInfo));i.surveyInfoClone.prepareDataAndShowModal()};i.showSurveyInfoPopupInternal=function(t,o){r=t;var s={};o&&(s.surveyId=o,i.SurveyId=o);i.SurveyInfo==null||i.SurveyInfo.IsEventRegistration30()?Webropol.Shared.Common.callAsync(s,n.getSurveyInfoViewModel,function(n){n.ErrorCode==0&&(i.SurveyInfo=new Webropol.Survey.SurveyInfoManager.SurveyInfo(u,e,i),i.SurveyInfo.init(n.ExtraData),f())}):f()};i.showSurveyInfoPopup=function(){i.showSurveyInfoPopupInternal(null)};i.showSurveyInfoPopupFromGrid=function(n,t,r){i.showSurveyInfoPopupInternal(n,t);i.ForceClickOnRights=r};i.saveSurveyInfo=function(){var n={viewModel:ko.mapping.toJS(i.surveyInfoClone,{ignore:["HistoryLog","SurveyViewRights","SurveyAddEditRights"]})},t=i.SurveyId;t&&(n.surveyId=t);i.surveyInfoClone.IsEventRegistration30()&&i.surveyInfoClone.EventSettings&&(n.viewModel.SurveyName=i.surveyInfoClone.EventSettings.EventName());Webropol.Shared.Common.callAsync(n,u.saveSurveyInfo,function(n){n.ErrorCode==0&&(ko.mapping.fromJS(n.ExtraData.SurveyInfo,{},i.SurveyInfo),ko.shared.notifySuccess(i,n.Message),$(".survey-file-name").length&&$(".survey-file-name").text(i.SurveyInfo.SurveyName()),r&&r(n.ExtraData))})}};Webropol=Webropol||{};Webropol.Survey=Webropol.Survey||{};Webropol.Survey.SurveyInfoManager=Webropol.Survey.SurveyInfoManager||{};Webropol.Survey.SurveyInfoManager.SurveyInfo=function(n,t,i){var r=this,u=n,e=t,h=null,f=null,s=ko.observable(!1),o;this.hidePopup;this.getManager=function(){return i};this.needToLoadHistory=!0;this.isShowFolderPathAsString=ko.observable(!1);this.IsValidSurveyName=ko.observable(!0);this.isGridLogsLoaded=ko.observable(!1);this.isGridRightsLoaded=ko.observable(!1);this.isGridRightsUpdateInProgress=ko.observable(!1);this.init=function(n){var t={KeywordsContainer:{create:function(n){if(n.data==null)return null;var t=new Webropol.Survey.KeywordsContainer(u,e,r);return t.init(n.data),t}},HistoryLog:{create:function(){return null}},SurveyViewRights:{create:function(){return null}},SurveyAddEditRights:{create:function(){return null}},EventSettings:{create:function(n){if(n.data){var t=new Webropol.Survey.EventRegistration.EditEventSettings(u,e,r);return t.init(n.data),t}return null}}};ko.mapping.fromJS(n,t,r);r.initializeComputed();r.subscribeOnValuesChanged();r.applyExtenders()};this.initializeComputed=function(){this.IsValidState=ko.computed(function(){return r.IsEventRegistration30()?!r.IsReadOnly()&&r.IsValidSurveyName()&&r.KeywordsContainer.IsValidLabels()&&r.EventSettings.canCreateEvent():!r.IsReadOnly()&&r.IsValidSurveyName()&&r.KeywordsContainer.IsValidLabels()});this.isUsedFilter=ko.pureComputed(function(){return(r.LogUserGroupType()!=0||r.LogActionType()!=Webropol.Shared.Common.guidEmpty)&&s()})};this.subscribeOnValuesChanged=function(){r.SurveyName.subscribe(function(n){r.IsValidSurveyName(n!=""&&n!=null)})};this.applyExtenders=function(){r.SurveyName.extend({trackChange:!0});r.Description.extend({trackChange:!0})};this.prepareDataAndShowModal=function(){l()};this.getDescriptionHeader=function(n,t){return r.getDescriptionLength()==0?n+" ("+t+")":n};this.getDescriptionLength=function(){return r.Description()==""||r.Description()==null?0:r.Description().length};this.canSaveSurveyInfo=function(){var n=!0;return(r.SurveyName==null||r.SurveyName=="")&&(n=!1),n};this.onSaveButtonClick=function(){r.hidePopup();i.saveSurveyInfo()};this.onDontSaveButtonClick=function(){r.hidePopup()};var l=function(){if(r.IsEventRegistration30())c(),r.getManager().needToLoadHistory&&r.loadHistoryLogGridData(),r.СanManageSurveyRights()&&r.loadSurveyRightsLogGridData();else{var n={},t=r.getManager().SurveyId;t&&(n.surveyId=t);Webropol.Shared.Common.callAsync(n,u.getQuestionsForExcelTemplate,function(n){ko.mapping.fromJS(n.ExtraData,{},r.KeywordsContainer.QuestionsForExcelTemplate);c();r.getManager().needToLoadHistory&&r.loadHistoryLogGridData();r.СanManageSurveyRights()&&r.loadSurveyRightsLogGridData()})}},c=function(){var n={},t=r.getManager().SurveyId;t&&(n.surveyId=t);h=ko.shared.showPopupFromTemplate(r.getManager().modalTemplateId,r,function(n){h=$(n);r.getManager().ForceClickOnRights==!0&&$("#surveyRightsTrigger").trigger("click")},u.getSurveyInfoTemplate,JSON.stringify(n),a,!0)},a=function(n){r.hidePopup=n;r.SurveyName.isDirty()||r.KeywordsContainer.Labels.isDirty()||r.Description.isDirty()?ko.shared.showPopupFromTemplate("survey-info-confirmation-popup-template",r):r.hidePopup()};this.onSearchClick=function(){f.logUserGroup=r.LogUserGroupType();f.logActionId=r.LogActionType();var n=r.getManager().SurveyId;n&&(f.surveyId=n);r.HistoryLog.setRequestData(f);r.HistoryLog.onApplyFilterClick();s(!0)};this.onShowAllClick=function(){r.LogUserGroupType(0);r.LogActionType(Webropol.Shared.Common.guidEmpty);f.logUserGroup=r.LogUserGroupType();f.logActionId=r.LogActionType();var n=r.getManager().SurveyId;n&&(f.surveyId=n);r.HistoryLog.onCancelFilterClick();s(!1)};this.isEnableShowBtn=function(){r.LogUserGroupType(0);r.LogActionType(Webropol.Shared.Common.guidEmpty);r.loadHistoryLogGridData()};this.loadHistoryLogGridData=function(){r.isGridLogsLoaded(!1);var t={},n=r.getManager().SurveyId;n&&(t.surveyId=n);Webropol.Shared.Common.callAsync(t,u.getHistoryLogGridData,function(t){var s={loadDataUrl:u.getHistoryInfoGridDataWithFilter},o;f={logUserGroup:r.LogUserGroupType(),logActionId:r.LogActionType()};n&&(f.surveyId=n);o={requestData:f};i.historyLogGrid=new Webropol.BossTools.GenericGrid(s,e,r,o);i.historyLogGrid.init(t);r.HistoryLog=i.historyLogGrid;r.isGridLogsLoaded(!0)})};this.loadSurveyRightsLogGridData=function(){r.isGridRightsLoaded(!1);var t={searchData:{SortBy:"UserClassName",IsAsc:!0,PageSize:50}},n=r.getManager().SurveyId;n&&(t.surveyId=n);Webropol.Shared.Common.callAsync(JSON.stringify(t),u.getSurveyRightsViewGridData,function(t){var s={loadDataUrl:u.getSurveyRightsViewGridData},o={};n&&(f={surveyId:n},o.requestData=f);i.surveyRightsGrid=new Webropol.BossTools.GenericGrid(s,e,r,o);i.surveyRightsGrid.init(t);r.SurveyViewRights=i.surveyRightsGrid;r.isGridRightsLoaded(!0)},function(){},function(){},!0)};this.onShowDetailsClick=function(n){Webropol.Shared.Common.callAsync({surveyActivityHistoryId:n.RowId()},u.getSurveyActivityHistoryDetails,function(t){n.Details=t;ko.shared.showPopupFromTemplate("survey-info-log-action-value-modal-template",n)})};this.saveSurveyInfo=function(n,t){if(r.IsEventRegistration30()){r.EventSettings.hideErrors();var i=r.EventSettings.validateEventSettings();i.isSuccess?(r.EventSettings.preprocessBasicInfoBeforeSave(),$(t.target).attr("data-dismiss","modal"),r.getManager().saveSurveyInfo()):r.EventSettings.showErrors(i.validationResults)}else $(t.target).attr("data-dismiss","modal"),r.getManager().saveSurveyInfo()};this.isReadOnlyKeywords=function(){return r.IsReadOnly()};this.onAddEditRightsClick=function(){var t={searchData:{SortBy:"UserClassName",IsAsc:!0,PageSize:50}},n=r.getManager().SurveyId,i;n&&(t.surveyId=n);i=ko.mapping.toJS(t);Webropol.Shared.Common.callAsync(i,u.getSurveyRightsAddEditGridData,function(t){var l={loadDataUrl:u.getSurveyRightsAddEditGridData},c={items:{"col-read":{click:o},"col-write":{click:o},"col-manage":{click:o}}},s,h,i;n&&(f={surveyId:n},c.requestData=f);s=new Webropol.BossTools.GenericGrid(l,e,r,c);s.init(t);r.SurveyAddEditRights=s;h=null;n&&(h={surveyId:n});i=new ko.shared.PopupOptions;i.TemplateName="survey-info-add-edit-survey-rights";i.Model=r;i.GetTemplateUrl=u.getSurveyRightsAddEditGridTemplate;i.TemplateModel=JSON.stringify(h);i.AfterAdjustModal=function(n){r.SurveyAddEditRights.initStickyHeaderForIe($(n))};ko.shared.showPopupFromTemplateWithOptions(i)})};o=function(i,u){return new Webropol.BossTools.AccessRightsCommon(r.SurveyAddEditRights,n,t).onAccessRightsChecked(i,u)};this.saveSurveyAccessRights=function(){r.isGridRightsUpdateInProgress(!0);var n={accessRights:r.fillAccessRightsToSave()},t=r.getManager().SurveyId;return t&&(n.surveyId=t),Webropol.Shared.Common.callAsync(JSON.stringify(n),u.saveSurveyAccessRights,function(n){n.ErrorCode==0&&(r.SurveyViewRights.reload(function(){r.isGridRightsUpdateInProgress(!1)}),ko.shared.notifySuccess(r,n.Message))},function(){r.isGridRightsUpdateInProgress(!1)})};this.fillAccessRightsToSave=function(){for(var i=[],u=r.SurveyAddEditRights.getChangedData(),n,t=0,f=u.length;t<f;t++)n=u[t],i.push({ItemId:n.RowId(),IsUserGroup:n.IsUserGroup(),Read:n.CheckedRead(),Write:n.CheckedWrite(),Manage:n.CheckedManage()});return i};this.exportSurveyHistoryLogExcel=function(){var n=r.getManager().SurveyId;window.location.href=n?u.exportSurveyHistoryLogExcel+"?surveyId="+r.getManager().SurveyId:u.exportSurveyHistoryLogExcel};this.exportSurveyHistoryLogCsv=function(){var n=r.getManager().SurveyId;window.location.href=n?u.exportSurveyHistoryLogCsv+"?surveyId="+r.getManager().SurveyId:u.exportSurveyHistoryLogCsv}};Webropol=Webropol||{};Webropol.Survey=Webropol.Survey||{};Webropol.Survey.SurveyInfoManager=Webropol.Survey.SurveyInfoManager||{};Webropol.Survey.SurveyInfoManager.SurveyInfo=Webropol.Survey.SurveyInfoManager.SurveyInfo||{};Webropol.Survey.SurveyInfoManager.SurveyInfo.SurveyLabel=function(n,t,i){var r=this,o=n,f=t,e,u;this.getSurveyInfo=function(){return i};this.init=function(n){ko.mapping.fromJS(n,{},r);r.subscribeOnValuesChanged();r.applyExtenders()};this.subscribeOnValuesChanged=function(){r.LabelName.subscribe(function(){r.IsPlaceholder()?u():r.IsPlaceholder()||(r.IsEdited(!0),i.Labels.isDirty(!0))})};this.applyExtenders=function(){r.LabelName.extend({trackChange:!0})};this.onPlaceholderPressKey=function(){return r.IsPlaceholder()&&u(),!0};this.onLabelDeleteClick=function(n){var t=f.labelDeleteModalBody.replace("{0}",n.LabelName());ko.shared.showConfirmDialog(t,e,function(){},f.labelDeleteModalHeader)};e=function(){r.Id()==Webropol.Shared.Common.guidEmpty?i.removeLabel(r):(r.LabelName(r.LabelName.originalValue),r.IsDeleted(!0));i.Labels.isDirty(!0)};u=function(){r.IsPlaceholder(!1);i.addPlaceholder()}};Webropol=Webropol||{};Webropol.BossTools=Webropol.BossTools||{};Webropol.BossTools.AccessRightsCommon=function(n,t,i){var u=this,f=t,e=i,r;this.onAccessRightsChecked=function(t,i){var f=n.getColumn(i),u=t[f.MapValue()]();switch(i){case"col-read":u?r(t):(t.CheckedWrite(!1),t.CheckedManage(!1),t.CheckedIsHomeFolder&&t.CheckedIsHomeFolder(!1));break;case"col-write":u?(t.CheckedRead(!0),r(t)):t.CheckedManage(!1);break;case"col-manage":u&&(t.CheckedRead(!0),r(t),t.CheckedWrite(!0));break;case"col-is-home-folder":u&&t.CheckedRead(!0)}};this.onAccessRightsFolderChecked=function(t,i){var f=n.getColumn(i),u=t[f.MapValue()]();switch(i){case"CheckedRead":u?r(t):t.CheckedManage(!1);break;case"CheckedManage":u&&(t.CheckedRead(!0),r(t))}};r=function(n){var f,e,t,o,i;if(n.ParentId&&(f=n.ParentId(),f))for(e=u.AccessRightsGridData.Items(),t=0,o=e.length;t<o;t++)if(i=e[t],i.RowId()==f){i.CheckedRead(!0);r(i);break}}}