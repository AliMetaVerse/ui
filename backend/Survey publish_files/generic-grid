var Webropol=Webropol||{};Webropol.Common=Webropol.Common||{};Webropol.Common.StickyHeader=function(n){var t,u,i,r=!1;this.init=function(){t=n.scrollParent();u=n.offset().top;i=t.offset().top;t.on("scroll",f);r=!0};this.destroy=function(){t.off("scroll",f);r=!1};this.isInitialized=function(){return r};var f=function(){var n=t.scrollTop();i+n>u?e():o()},e=function(){n.css("position","fixed");n.css("top",i+"px");n.is("thead")&&s(n)},o=function(){n.css("position","");n.css("top","");n.is("thead")&&h(n)},s=function(n){var t=[];n.parent().find("tbody tr:first td").each(function(){t.push($(this).outerWidth())});n.find("th").each(function(n){$(this).css("width",t[n]+"px")})},h=function(n){n.find("th").each(function(){$(this).css("width","")})}};Webropol=Webropol||{};Webropol.BossTools=Webropol.BossTools||{};Webropol.BossTools.ExcelFilter=function(n,t,i){var r=this,f=null,o=n.ColumnId(),e=t;r.filterChange=null;r.SrcFieldSelect={};r.SrcFieldDate={};r.SrcFieldText={};r.SrcFieldNumeric={};r.NewFieldSelect={};r.NewFieldDate={};r.NewFieldText={};r.NewFieldNumeric={};this.getColumn=function(){return n};this.isShown=ko.observable(!1);this.isSortDesc=ko.observable(!1);this.isSortAsc=ko.observable(!1);this.onSort=function(n){r.isSortAsc(n);r.isSortDesc(!n)};this.isAllChecked=ko.observable(!1);this.clickAllChecked=function(n,t){var e=$(t.target).is(":checked"),u,i,f;if(r.NewFieldSelect.Items)for(u=r.NewFieldSelect.Items(),i=0,f=u.length;i<f;i++)u[i].IsChecked(e)};this.updateAllChecked=function(){var n,f;if(r.NewFieldSelect.Items){var i=r.NewFieldSelect.Items(),u=0,t=0;for(n=0,f=i.length;n<f;n++)t++,i[n].IsChecked()&&u++;t>0&&r.isAllChecked(u==t)}};var h=function(){u(r.SrcFieldSelect,r.FieldSelect);u(r.SrcFieldDate,r.FieldDate);u(r.SrcFieldText,r.FieldText);u(r.SrcFieldNumeric,r.FieldNumeric)},s=function(){u(r.NewFieldSelect,r.FieldSelect);u(r.NewFieldDate,r.FieldDate);u(r.NewFieldText,r.FieldText);u(r.NewFieldNumeric,r.FieldNumeric)},u=function(n,t,i){var r,u,f;return t&&(r=ko.mapping.toJS(t),ko.mapping.fromJS(r,{},n),i)?(u=ko.utils.stringifyJson(r),f=ko.mapping.toJSON(i),f!=u):!1},c=function(){var n=!1;u(r.FieldSelect,r.NewFieldSelect,r.SrcFieldSelect)&&(n=!0);u(r.FieldDate,r.NewFieldDate,r.SrcFieldDate)&&(n=!0);u(r.FieldText,r.NewFieldText,r.SrcFieldText)&&(n=!0);u(r.FieldNumeric,r.NewFieldNumeric,r.SrcFieldNumeric)&&(n=!0);r.IsSet(n);e&&(r.isSortAsc()||r.isSortDesc())&&(e.ColumnId(o),e.IsAsc(r.isSortAsc()));r.filterChange&&r.filterChange()},l=function(){var i,u,t,f;if(r.FieldSelect){for(i="",u=r.FieldSelect.Items(),t=0,f=u.length;t<f;t++)u[t].IsChecked()&&(i==""?i=u[t].Name():i+=", "+u[t].Name());return n.ColumnName()+": "+i}return""},a=function(){var t,u,f,e;return r.FieldDate&&(t=r.FieldDate.FromDate(),u=r.FieldDate.ToDate(),t||u)?(f=t?" "+i.FilterFrom+" "+Webropol.Common.formatNumberLength(t.getDate(),2)+"."+Webropol.Common.formatNumberLength(t.getMonth()+1,2)+"."+t.getFullYear():"",e=u?i.FilterTo+" "+Webropol.Common.formatNumberLength(u.getDate(),2)+"."+Webropol.Common.formatNumberLength(u.getMonth()+1,2)+"."+u.getFullYear():"",n.ColumnName()+":"+f+" "+e):""},v=function(){if(r.FieldText){var t=r.FieldText.Value();if(t)return n.ColumnName()+": "+i.FilterContains+' "'+t+'"'}return""},y=function(){var t,u,f,e;return r.FieldNumeric&&(t=r.FieldNumeric.FromValue(),u=r.FieldNumeric.ToValue(),t||u)?(f=t?" "+i.FilterFrom+" "+t:"",e=u?i.FilterTo+" "+u:"",n.ColumnName()+":"+f+" "+e):""};this.onClear=function(){r.IsSet()&&(u(r.FieldSelect,r.SrcFieldSelect),u(r.FieldDate,r.SrcFieldDate),u(r.FieldText,r.SrcFieldText),u(r.FieldNumeric,r.SrcFieldNumeric),r.IsSet(!1),r.closePopupAndRestoreData(),r.filterChange&&r.filterChange())};this.onOk=function(){r.hide();c()};this.closePopupAndRestoreData=function(){r.hide();s()};this.hide=function(){f&&f.hide();r.isShown(!1)};this.show=function(n){var t,u,i;r.isShown(!0);e&&(e.ColumnId()==o?(t=e.IsAsc(),r.isSortAsc(t),r.isSortDesc(!t)):(r.isSortAsc(!1),r.isSortDesc(!1)));u="excel-filter-template";f||(f=$('<div class="excel-filter-dlg" data-bind="template: { name: \''+u+"', data: $data }\"><\/div>"),$("body").append(f),ko.applyBindings(r,f[0]));f.show();i=$(n).offset();f.css({top:function(){return i.top+$(n).outerHeight()},left:function(){return i.left}});r.updateAllChecked()};this.getConditionText=function(){return r.FilterType()==Webropol.Constants.ExcelFilterType.Select?l():r.FilterType()==Webropol.Constants.ExcelFilterType.Date?a():r.FilterType()==Webropol.Constants.ExcelFilterType.Text?v():r.FilterType()==Webropol.Constants.ExcelFilterType.Numeric?y():""};this.updateMapping=function(n){ko.mapping.fromJS(n,{},r);h();s()};this.init=function(n){r.updateMapping(n);r.initializeComputed()};this.initializeComputed=function(){this.CanApplyField=ko.computed(function(){var o,n,s,t,i;if(r.NewFieldSelect.Items){for(o=r.NewFieldSelect.Items(),n=0,s=o.length;n<s;n++)if(o[n].IsChecked())return!0}else if(r.NewFieldDate.FromDate&&r.NewFieldDate.ToDate){if(t=r.NewFieldDate.FromDate(),i=r.NewFieldDate.ToDate(),t!=null&&i!=null)return Date.parse(t)<=Date.parse(i);if(t!=null||i!=null)return!0}else{if(r.NewFieldText.Value)return r.NewFieldText.Value()!="";if(r.NewFieldNumeric.FromValue&&r.NewFieldNumeric.ToValue){var u=r.NewFieldNumeric.FromValue()||"",f=r.NewFieldNumeric.ToValue()||"",e=new RegExp("^-?[0-9]\\d*(\\.\\d*)?$");if(e.test(u)&&e.test(f))return parseFloat(u)<=parseFloat(f);if(u=="")return e.test(f);if(f=="")return e.test(u)}}return!1},r)}};Webropol=Webropol||{};Webropol.BossTools=Webropol.BossTools||{};Webropol.BossTools.GenericFilter=function(){var n=this,t=function(n){var t=new Webropol.BossTools.GenericFilter.FilterProperty;return t.init(n),t};this.GetFilterProperty=function(t){for(var r=n.FilterProperties(),i=0,u=r.length;i<u;i++)if(r[i].Id()==t)return r[i];return null};this.updateMapping=function(i){var r={FilterProperties:{create:function(n){return t(n.data)}}};ko.mapping.fromJS(i,r,n)};this.init=function(t){n.updateMapping(t)}};Webropol.BossTools.GenericFilter.FilterProperty=function(){var n=this;this.HasFilterOptions=ko.computed({read:function(){return n.FilterOptions()&&n.FilterOptions().length>0},deferEvaluation:!0});this.updateMapping=function(t){ko.mapping.fromJS(t,{},n)};this.init=function(t){n.updateMapping(t)}};Webropol=Webropol||{};Webropol.BossTools=Webropol.BossTools||{};Webropol.BossTools.GenericGridColumn=function(n,t,i,r,u){var f=this,s=t,e=null,o;f.columnCheckboxIsExplicitlySet=ko.observable(null);this.getGrid=function(){return n};this.updateMapping=function(n){var t={ExcelFilter:{create:function(n){return o(n.data)}}};ko.mapping.fromJS(n,t,f)};this.init=function(n){f.updateMapping(n,u)};this.saveClone=function(){e=ko.mapping.toJS(f)};this.getClone=function(){return e};this.removeClone=function(){e=null};this.editColumnTitle=function(){f.IsColumnTitleInEditMode(!0);f.saveClone()};this.deleteColumn=function(){var n=i.deleteColumn,t;if(n.onColumnDelete){t={columnId:f.ColumnId(),columnName:f.ColumnName()};n.onColumnDelete(t)}};this.acceptColumnTitleChanges=function(){var t=function(){if(n.saveColumnTitleChanges){var t={columnId:f.ColumnId(),columnName:f.ColumnName()};n.saveColumnTitleChanges(t,r)}else r()},r=function(){f.removeClone();f.IsColumnTitleInEditMode(!1)},n;f.validateEditedColumn()&&(n=i.editColumnTitle||{},(!n.canColumnTitleEdit||n.canColumnTitleEdit(f))&&(n.beforeColumnTitleEdit?n.beforeColumnTitleEdit(f,t):t()))};this.cancelColumnTitleChanges=function(){var n=f.getClone();f.init(n);f.removeClone();f.IsColumnTitleInEditMode(!1)};this.validateEditedColumn=function(){var t=i.editColumnTitle||{},n;return t.validateEditedColumn?t.validateEditedColumn(f):(n=f.ColumnName(),n!=null&&n.length>0)};o=function(t){if(t){var i=new Webropol.BossTools.ExcelFilter(f,n.Sorting,r);return i.init(t),u(i),i}return null}};Webropol=Webropol||{};Webropol.BossTools=Webropol.BossTools||{};Webropol.BossTools.GenericGridPager=function(n){var t=this,i=n,r,u;this.init=function(n){r(n);u()};this.firstPageClick=function(){if(t.IsFirst())return!1;t.pageClick(1,t.PageSize())};this.lastPageClick=function(){if(t.IsLast())return!1;t.pageClick(t.TotalPages(),t.PageSize())};this.prevPageClick=function(){if(!t.HasPrevious())return!1;t.pageClick(t.PrevPageIndex(),t.PageSize())};this.nextPageClick=function(){if(!t.HasNext())return!1;t.pageClick(t.NextPageIndex(),t.PageSize())};this.setPageSizeClick=function(n,i){t.pageClick(1,i)};this.pageClick=function(n,t){typeof i=="function"&&i(n,t)};r=function(n){ko.mapping.fromJS(n,{},t)};u=function(){t.IsFirst=ko.pureComputed({read:function(){return t.PageIndex()===1}});t.IsLast=ko.pureComputed({read:function(){return t.PageIndex()===t.TotalPages()}});t.HasPrevious=ko.pureComputed({read:function(){return t.PageIndex()>1}});t.HasNext=ko.pureComputed({read:function(){return t.PageIndex()<t.TotalPages()}});t.PrevPageIndex=ko.pureComputed({read:function(){return t.HasPrevious()?t.PageIndex()-1:t.PageIndex()}});t.NextPageIndex=ko.pureComputed({read:function(){return t.HasNext()?t.PageIndex()+1:t.PageIndex()}});t.TotalPages=ko.pureComputed({read:function(){return t.PageSize()===0||t.TotalItemsCount()===0?1:Math.ceil(t.TotalItemsCount()/t.PageSize())}})}};Webropol=Webropol||{};Webropol.BossTools=Webropol.BossTools||{};Webropol.BossTools.GenericGridRow=function(n,t,i){var r=this,e=n,u=t,f=null;this.Expanded=ko.observable(!1);this.IsVisible=ko.computed({read:function(){return u?u.Expanded()&&u.IsVisible():!0},deferEvaluation:!0});this.updateMapping=function(n){ko.mapping.fromJS(n,{},r)};this.init=function(n){r.initObservables();r.updateMapping(n)};this.initObservables=function(){r.cssString=ko.computed(function(){var n=r.CssClass&&r.CssClass()!=null?r.CssClass():"";return e.UseRowEditing()&&(n+=" add-or-edit-row"),n})};this.saveClone=function(){f=ko.mapping.toJS(r)};this.getClone=function(){return f};this.removeClone=function(){f=null};this.editRow=function(){r.canRowEdit()&&(r.saveClone(),r.IsRowInEditMode(!0))};this.canRowEdit=function(){var n=i.editRow||{};return n.canRowEdit?n.canRowEdit(r):!0};this.validateEditedRow=function(){return n.validateEditedRow(r)};this.acceptRowChanges=function(){var u=function(){if(t.saveRowChanges){var n=ko.mapping.toJS(r);t.saveRowChanges(n,f)}else f()},f=function(){r.removeClone();r.IsRowInEditMode(!1)},t;n.validateEditedRow(r)&&(t=i.editRow||{},(!t.canRowEdit||t.canRowEdit(r))&&(t.beforeRowEdit?t.beforeRowEdit(r,u):u()))};this.cancelRowChanges=function(){var n=r.getClone();r.init(n);r.removeClone();r.IsRowInEditMode(!1)};this.getTipText=function(n,t,i){var r,u,f;return n==null||$.trim(t).length==0?"":(r=n[t],r==null)?"":(u=$.trim(r()),f=$.trim(i),f.length>0?Webropol.Shared.Common.stringFormat(f,u):u)}};Webropol=Webropol||{};Webropol.BossTools=Webropol.BossTools||{};Webropol.BossTools.GenericGridColumns={Text:0,Tree:1,Check:2,Button:3,Hyperlink:4,Radio:5,Image:6,TextEdit:7,Custom:100};Webropol.BossTools.GenericGrid=function(n,t,i,r){var b=n,u=this,g,it,p,w;r=r||{};var e=null,s=0,d=100,h=[],k=ko.observable([]),l=ko.observable([]),a=!0,o={};this.isSomeRowsExpanded=ko.computed({read:function(){return k().length>0},deferEvaluation:!0});this.isSomeItemsChecked=function(n){var t=l()[n];return t==!0};this.isDirty=ko.observable(!1);this.isLoading=ko.computed({deferEvaluation:!0,read:function(){return e?e.animating():!1}});this.getColumn=function(n){for(var i=u.Columns(),t=0,r=i.length;t<r;t++)if(i[t].ColumnId()==n)return i[t];return null};this.getCellValue=function(n,t){return n[u.getColumn(t).MapValue()]()};this.getRequestData=function(){return r.requestData};this.setRequestData=function(n){r.requestData&&(r.requestData=n)};var v=function(){for(var i=u.Items(),n,t=0,r=i.length;t<r;t++)n=i[t],n.dirtyFlag||(n.dirtyFlag=new ko.shared.oneTimeDirtyFlag(n),n.dirtyFlag.subscribe(function(){u.isDirty(!0)}))},ft=function(n){var i=new Webropol.BossTools.GenericGridColumn(u,h[n.ParentId],r,t,rt);return i.init(n,rt),i},c=function(n){if(!n.RowId)throw new Error("RowId is required for GenericGridRowViewModel");var t=new Webropol.BossTools.GenericGridRow(u,h[n.ParentId],r);return t.init(n),h[n.RowId]=t,t},et=function(n){var t=new Webropol.BossTools.GenericFilter(u,r);return t.init(n),t},ot=function(n){if(!n)return null;var t=new Webropol.BossTools.GenericGridPager(u.onPageClick);return t.init(n),t};this.onPageClick=function(n,t){var i=null,r=!1;u.UseSorting()&&(i=u.Sorting.ColumnId(),r=u.Sorting.IsAsc());u.loadPage(n,t,i,r)};g=function(row){for(var columns=u.Columns(),property,value,i=0,j=columns.length;i<j;i++)property=eval("row."+columns[i].MapValue()),value=ko.unwrap(property),typeof value=="string"&&property("")};this.validateNewRow=function(row){for(var columns=u.Columns(),propertyValues=[],property,propertyValue,inputType,isOptional,options,i=0,j=columns.length;i<j;i++){if(property=eval("row."+columns[i].MapValue()),propertyValue=ko.unwrap(property),propertyValues.push(propertyValue),typeof propertyValue=="string"&&!propertyValue)return!1;if(inputType=columns[i].AddInputType(),isOptional=columns[i].IsOptional(),inputType=="email")if(isOptional){if(!Webropol.Common.validateOptionalEmail(propertyValue))return!1}else if(!Webropol.Common.validateRequiredEmail(propertyValue))return!1}return(options=r.editRow||{},options.customRowValidation)?options.customRowValidation(propertyValues):!0};this.validateEditedRow=function(row){for(var columns=u.Columns(),propertyValues=[],property,propertyValue,inputType,isOptional,options,i=0,j=columns.length;i<j;i++)if(property=eval("row."+columns[i].MapValue()),propertyValue=ko.unwrap(property),propertyValues.push(propertyValue),inputType=columns[i].AddInputType(),isOptional=columns[i].IsOptional(),inputType=="email")if(isOptional){if(!Webropol.Common.validateOptionalEmail(propertyValue))return!1}else if(!Webropol.Common.validateRequiredEmail(propertyValue))return!1;return(options=r.editRow||{},options.customRowValidation)?options.customRowValidation(propertyValues):!0};this.addNewRow=function(n){var t,f,i;u.validateNewRow(n)&&(t=r.newrow||{},(!t.canAdd||t.canAdd(n))&&(f=ko.mapping.toJS(n),i=c(f),t.beforeAdd&&t.beforeAdd(i),u.Items.push(i),g(n)))};this.pushNewRow=function(n){var t=ko.mapping.toJS(n),i=c(t);u.Items.unshift(i)};this.insertNewRowAfterExisting=function(n,t){for(var e=ko.mapping.toJS(n),o=c(e),r=u.Items(),f=-1,i=0;i<r.length;i++)r[i]===t&&(f=i);if(f===-1)throw new Error("Grid row not found");r.splice(f+1,0,o);u.Items(r)};this.removeRow=function(n){var i=ko.unwrap(n.RowId),r,t;u.Items.remove(n);for(r in h)t=h[r],t&&t.ParentId()==i&&u.removeRow(t);h[i]=null};this.getRowById=function(n){return h[n]};var nt=function(n,t){var i={offset:s,pageSize:d};r.requestData&&$.extend(i,r.requestData);Webropol.Shared.Common.callAsync(JSON.stringify(i),b.loadDataUrl,function(i){i?n(i):t()},function(){t()})},y=function(n,t){n?u.MultiPagingSelection.SelectedRowIds.indexOf(t)===-1&&u.MultiPagingSelection.SelectedRowIds.push(t):u.MultiPagingSelection.SelectedRowIds.remove(function(n){return n==t})},tt=function(column,checked,rows){var updatedRows=[],opt=r.columns&&r.columns[column.ColumnId()],handleRowState,i,j,rowId;if(column){for(handleRowState=u.UseMultiPagingSelection()&&column.ColumnId()===u.MultiPagingSelection.ColumnId(),i=0,j=rows.length;i<j;i++){var row=rows[i],property=eval("row."+column.MapValue()),isReadonly=row[column.ReadonlyMap()];isReadonly||(isReadonly=ko.observable(row.IsReadonly!=null&&row.IsReadonly()));property&&ko.isObservable(isReadonly)&&!isReadonly()&&(property()!=checked&&updatedRows.push(row),property(checked),handleRowState&&(rowId=row.RowId(),o[rowId]=checked,y(checked,rowId)),opt&&opt.click||u.itemClick(row,column.ColumnId(),null))}opt&&opt.click&&opt.click(updatedRows,checked)}},st=function(){var t=s,n;return u.UseZeroOffsetForLiveScrolling()||(s+=d),n=$.Deferred(),nt(function(i){var l,o,p,y,a,w,h,f,b;if($.isFunction(r.dataProcessorFunc)&&(i=r.dataProcessorFunc(i)),l=[],i.Items&&i.Items.length>0)for(o=0,p=i.Items.length;o<p;o++)i.Items[o]&&(y=c(i.Items[o]),u.Items.push(y),l.push(y));else s=t,e.toggle(!1);if(i.Columns&&i.Columns.length>0)for(a=0,w=i.Columns.length;a<w;a++)h=i.Columns[a],h&&(f=u.getColumn(h.ColumnId),f&&(f.columnCheckboxIsExplicitlySet()===null&&h.AreAllInvisibleChecked!=undefined&&f.AreAllInvisibleChecked!=undefined&&typeof f.AreAllInvisibleChecked=="function"&&f.AreAllInvisibleChecked(h.AreAllInvisibleChecked),f.columnCheckboxIsExplicitlySet()!==null&&l.length>0&&(b=f.columnCheckboxIsExplicitlySet(),tt(f,b,l))));v();n.resolve()},function(){s=t;n.resolve()}),n.promise()},ht=function(){for(var i=[],r=u.Items(),t,n=0,f=r.length;n<f;n++)t=r[n],t.HasChilds()&&t.Expanded()&&i.push(t.RowId());return i};this.expandTreeGridRow=function(n,t){var i=typeof t!="undefined"?t:!n.Expanded();n.Expanded(i);k(ht())};this.getChangedData=function(){for(var i=[],r=u.Items(),t,n=0,f=r.length;n<f;n++)t=r[n],t.dirtyFlag()&&i.push(t);return i};this.getAllData=function(){for(var t=[],i=u.Items(),f,n=0,r=i.length;n<r;n++)f=i[n],t.push(f);return t};this.renderCustomItem=function(n,t){var i=r.items[t];return i&&i.renderer?i.renderer(n,t):""};this.renderTreeGridItemIndent=function(n){for(var i="",t=0,r=n.Level();t<r;t++)i+="<span class='indent'><\/span>";return i};this.renderTreeGridItemIcon=function(n,t){var u=function(n,t){var i,u,e,f;if(!r.items)return null;if(i=r.items[t],i&&i.icons)for(u=0,e=i.icons.length;u<e;u++)if(f=i.icons[u],f.type==n.ItemType())return f.css;return null},i=u(n,t);return i?Webropol.Shared.Common.stringFormat("<i class='fa {0}'><\/i>",i):""};this.renderTreeGridItemValue=function(n,t){var f=u.getCellValue(n,t),i=r.items[t];return i&&i.renderItemValue&&(f=i.renderItemValue(n,t)),f};this.checkColumnClick=function(n,t,i){var e,o,s,f;a=!1;e=$(t.target).is(":checked");o=u.getColumn(i);o&&(u.updateColumnCheckbox(i,e),s=u.Items(),tt(o,e,s),f=r.items&&r.items[i],f&&f.headerClick&&f.headerClick(i));a=!0;u.updateCheckedItemsStatuses()};this.treeColumnClick=function(){for(var f=u.isSomeRowsExpanded(),e=!f,i=u.Items(),t,n=0,r=i.length;n<r;n++)t=i[n],t.HasChilds()&&u.expandTreeGridRow(t,e)};this.updateExpandedRows=function(){ko.utils.arrayForEach(k(),function(n){var t=u.getRowById(n);t&&ko.isObservable(t.Expanded)&&t.Expanded(!0)})};it=function(){u.UseMultiPagingSelection()&&(!u.MultiPagingSelection.ColumnIds||u.MultiPagingSelection.ColumnIds.length===0)?ko.utils.arrayForEach(u.Items(),function(row){var clientValue=o[row.RowId()],property;clientValue!==undefined&&(property=eval("row."+u.MultiPagingSelection.ColumnId()),property&&property(clientValue))}):u.UseMultiPagingSelection()&&u.MultiPagingSelection.ColumnIds&&u.MultiPagingSelection.ColumnIds().length!==0&&ko.utils.arrayForEach(u.Items(),function(n){u.MultiPagingSelection.ColumnIds().forEach(function(columnId){var clientValue=o[n.RowId()+"-"+columnId],property;clientValue!==undefined&&(property=eval("row."+columnId),property&&property(clientValue))})})};p=function(n){var t,i,c,f,e,o;if(a&&(t=u.getColumn(n),t)){if(t.UseAllInvisibleChecked()&&!t.AreAllInvisibleChecked())l()[n]=!1;else{var s=u.Items(),h=0,r=0;for(i=0,c=s.length;i<c;i++)(f=s[i],e=f[t.ReadonlyMap()],ko.isObservable(e)&&e())||(o=f[t.MapValue()],o&&(r++,o()&&h++));l()[n]=r>0&&h==r}l.notifySubscribers()}};this.updateCheckedItemsStatuses=function(){for(var i=u.Columns(),t,n=0,r=i.length;n<r;n++)t=i[n],t&&t.RenderType()==Webropol.BossTools.GenericGridColumns.Check&&p(t.ColumnId())};this.updateColumnCheckbox=function(n,t){var i=u.getColumn(n);i&&(i.columnCheckboxIsExplicitlySet(t),i.UseAllInvisibleChecked()&&i.AreAllInvisibleChecked(t))};this.selectAllRowItems=function(n){for(var t=0,i=n.HandlerGroups().length;t<i;t++)n.HandlerGroups()[t].IsChecked=n.SelectAllRowItems()==!0?!0:!1;n.HandlerGroups.notifySubscribers()};this.itemClick=function(row,columnId,event){var columnOption,column,isCheckColumn,isContainsColumn,handleRowState,rowId,property,propertyValue;r.items&&(columnOption=r.items[columnId],columnOption&&columnOption.click&&columnOption.click(row,columnId,event));column=u.getColumn(columnId);isCheckColumn=column&&column.RenderType()==Webropol.BossTools.GenericGridColumns.Check;a&&isCheckColumn&&u.updateCheckedItemsStatuses();isContainsColumn=u.MultiPagingSelection.ColumnIds&&u.MultiPagingSelection.ColumnIds().indexOf(column.ColumnId())!==-1;handleRowState=u.UseMultiPagingSelection()&&(column.ColumnId()===u.MultiPagingSelection.ColumnId()||isContainsColumn);handleRowState&&(rowId=row.RowId(),isContainsColumn?(property=eval("row."+columnId),property&&(propertyValue=property(),o[rowId+"-"+columnId]=propertyValue,y(propertyValue,rowId+"-"+columnId))):(property=eval("row."+u.MultiPagingSelection.ColumnId()),property&&(propertyValue=property(),o[rowId]=propertyValue,y(propertyValue,rowId))))};this.columnClick=function(n,t){var i,f,e,r;u.UseSorting()&&u.Sorting&&(i=u.getColumn(t),i&&i.UseSorting())&&(u.Sorting.ColumnId()==t?u.Sorting.IsAsc(!u.Sorting.IsAsc()):(u.Sorting.IsAsc(!1),u.Sorting.ColumnId(t)),u.Pager?(f=ko.unwrap(u.Pager)?u.Pager.PageIndex():null,e=ko.unwrap(u.Pager)?u.Pager.PageSize():null,u.loadPage(f,e,u.Sorting.ColumnId(),u.Sorting.IsAsc())):(r=i.MapValue(),u.Items.sort(function(n,t){var i=n[r](),f=t[r]();return i===f?0:u.Sorting.IsAsc()?i<f?-1:1:i>f?-1:1})))};this.IsSortingAsc=function(n){return u.UseSorting()&&u.Sorting.ColumnId()==n&&u.Sorting.IsAsc()};this.IsSortingDesc=function(n){return u.UseSorting()&&u.Sorting.ColumnId()==n&&!u.Sorting.IsAsc()};this.getSearchData=function(){return{filter:ko.mapping.toJS(u.Filtering.SelectedFilter),sortBy:u.Sorting.ColumnId(),isAsc:u.Sorting.IsAsc(),pageIndex:u.Pager.PageIndex(),pageSize:u.Pager.PageSize()}};this.onEnter=function(n,t){return t.keyCode===13&&u.onApplyFilterClick(),!0};this.onApplyFilterClick=function(){var i,n,t,r,f;u.Filtering&&u.Filtering.NewFilter&&(i=ko.mapping.toJS(u.Filtering.NewFilter),ko.mapping.fromJS(i,{},u.Filtering.SelectedFilter),n=null,t=!1,u.UseSorting()&&(n=u.Sorting.ColumnId(),t=u.Sorting.IsAsc()),u.Pager?(r=ko.unwrap(u.Pager)?1:null,f=ko.unwrap(u.Pager)?u.Pager.PageSize():null,u.Pager.PageIndex(1),u.loadPage(r,f,n,t)):u.loadAllData(n,t))};this.canClearFilter=function(){var n=u.Filtering.SelectedFilter&&u.Filtering.SelectedFilter.SearchText()&&u.Filtering.SelectedFilter.SearchText().length>0,t=u.Filtering.NewFilter&&u.Filtering.NewFilter.SearchText()&&u.Filtering.NewFilter.SearchText().length>0;return n||t};this.onCancelFilterClick=function(){var i,n,t,r,f;u.Filtering&&u.Filtering.SelectedFilter&&(u.Filtering.SelectedFilter.SelectedProperty(0),u.Filtering.SelectedFilter.SelectedOperation(1),u.Filtering.SelectedFilter.SearchText(null),u.Filtering.SelectedFilter.SelectedOption(null),i=ko.mapping.toJS(u.Filtering.SelectedFilter),ko.mapping.fromJS(i,{},u.Filtering.NewFilter),n=null,t=!1,u.UseSorting()&&(n=u.Sorting.ColumnId(),t=u.Sorting.IsAsc()),u.Pager?(r=ko.unwrap(u.Pager)?1:null,f=ko.unwrap(u.Pager)?u.Pager.PageSize():null,u.loadPage(r,f,n,t)):u.loadAllData(n,t))};var f=[],ct=function(){u.Pager&&u.Pager.PageIndex(1);u.reload()},rt=function(n){n.filterChange=function(){ct(this)};f[n.getColumn().ColumnId()]=n};this.excelFilterClick=function(n,t){var e=t.ColumnId(),r,i;for(r in f)i=f[r],r==e?i.isShown()?i.closePopupAndRestoreData():i.show(n.target,u.Sorting):i.closePopupAndRestoreData()};this.isExcelFilterOpened=function(n){var t=f[n];return t?t.isShown():!1};this.isExcelFilterApplied=function(n){var t=f[n];return t?t.IsSet():!1};this.getExcelFilterIndex=function(n){var i=0,t;for(t in f)if(f[t].IsSet()&&(i++,t==n))return i;return null};this.isLastAppliedExcelFilter=function(n){var t=0,i;for(i in f)f[i].IsSet()&&t++;return t==0?!0:this.getExcelFilterIndex(n)==t};this.SomeExcelFiltersApplied=ko.computed({read:function(){for(var i=u.Columns(),t,n=0,r=i.length;n<r;n++)if(t=f[i[n].ColumnId()],t&&t.IsSet())return!0;return!1},deferEvaluation:!0});w=function(n,t){Webropol.Shared.Common.callAsync(JSON.stringify(n),b.loadDataUrl,function(){}).done(function(n){n.ErrorCode!==undefined?n.ErrorCode==0?(u.updateMapping(n.ExtraData),t&&t(n)):n.Message!==undefined&&ko.shared.notifyError(u,n.Message):(u.updateMapping(n),t&&t(n),r&&r.onLoad&&r.onLoad(n));$('[data-toggle="popover"]').popover({sanitize:!1});r.afterLoad&&r.afterLoad()})};this.loadPage=function(n,t,i,f,e){if(u.Pager){var o=ut(i,f);o.pageIndex=n;o.pageSize=t;r.beforeLoad&&r.beforeLoad();w(o,e)}};this.loadAllData=function(n,t,i){var u=ut(n,t);r.beforeLoad&&r.beforeLoad();w(u,i)};var ut=function(n,t){var i={sortBy:n,isAsc:t},s,h,e,o;u.ExternalFiltering?(s=ko.mapping.toJS(u.ExternalFiltering),$.extend(i,{filter:s})):u.Filtering&&u.Filtering.SelectedFilter&&(h=ko.mapping.toJS(u.Filtering.SelectedFilter),$.extend(i,{filter:h}));e=[];for(o in f)f[o].IsSet()&&e.push(ko.mapping.toJS(f[o]));return e.length&&$.extend(i,{excelFilters:e}),r.requestData&&$.extend(i,r.requestData),i},lt=function(n){var i=ko.unwrap(u.Pager),f,e,t;return i?(f=null,e=!1,u.UseSorting()&&(f=u.Sorting.ColumnId(),e=u.Sorting.IsAsc()),u.loadPage(i.PageIndex(),i.PageSize(),f,e,n)):(t={},u.UseSorting()&&$.extend(t,{sortBy:u.Sorting.ColumnId(),isAsc:u.Sorting.IsAsc()}),r&&$.extend(t,r.requestData),w(t,n)),!1},at=function(n,t){e.toggle(!1);s=0;var i=$.Deferred();return nt(function(f){$.isFunction(r.dataProcessorFunc)?(f=r.dataProcessorFunc(f),u.updateMapping(f),v()):f.Items&&(f.Items.length>0||t)&&(u.updateMapping(f),v(),n&&n(f));e.toggle(!0);i.resolve()}),i.promise()};this.reload=function(n,t){return u.UseLiveScrolling()?at(n,t):lt(n)};this.reloadCurrentPage=function(n){var t=ko.unwrap(u.Pager),i,r;t&&(i=null,r=!1,u.UseSorting()&&(i=u.Sorting.ColumnId(),r=u.Sorting.IsAsc()),u.loadPage(t.PageIndex(),t.PageSize(),i,r,n))};this.exportToExcel=function(){function t(t){var r=ko.mapping.toJS(t),i;for(i in r)$("<input />").attr("type","hidden").attr("name",i).val(r[i]).appendTo(n)}var n=$(".ExportToExcelForm");n.find("input[type='hidden']").remove();u.Filtering&&u.Filtering.SelectedFilter&&t(u.Filtering.SelectedFilter);u.Sorting&&t(u.Sorting);n.attr("action",b.exportToExcelUrl);n.trigger("submit")};this.getExportButtonToolTip=function(){return this.ExportToolTip()};this.getSelectedRows=function(n){var r,f,i,e,t;for(n=n||"IsSelected",r=[],f=u.Items(),i=0,e=f.length;i<e;i++)t=f[i],t.hasOwnProperty(n)&&ko.isObservable(t[n])&&t[n]()&&r.push(t);return r};this.getSelectedRowIds=function(n){var i=u.getSelectedRows(n),t=[];return $.each(i,function(n,i){t.push(i.RowId())}),t};this.clearSelection=function(){u.UseMultiPagingSelection()&&(ko.utils.arrayForEach(u.MultiPagingSelection.SelectedRowIds(),function(n){o[n]=!1}),ko.utils.arrayForEach(u.Items(),function(row){var property=eval("row."+u.MultiPagingSelection.ColumnId());property(!1)}),u.MultiPagingSelection.SelectedRowIds.removeAll(),p(u.MultiPagingSelection.ColumnId()),u.isDirty(!0))};this.selectAll=function(n){u.UseMultiPagingSelection()&&(ko.utils.arrayForEach(n,function(n){o[n]=!0;y(!0,n)}),ko.utils.arrayForEach(u.Items(),function(row){var property=eval("row."+u.MultiPagingSelection.ColumnId());property(!0)}),p(u.MultiPagingSelection.ColumnId()),u.isDirty(!0))};this.updateMapping=function(n,t){t=t||!1;var i={Columns:{create:function(n){return ft(n.data)}},Items:{create:function(n){return c(n.data)}},Filtering:{create:function(n){return et(n.data)}},Pager:{create:function(n){return ot(n.data)}}};t||(i.ignore=["MultiPagingSelection"]);ko.mapping.fromJS(n,i,u);v();u.UseMultiPagingSelection()&&it();u.updateCheckedItemsStatuses();u.updateExpandedRows()};this.init=function(n){u.updateMapping(n,!0);u.UseLiveScrolling()&&(e=new Webropol.Shared.ScrollLoader(st));$(document).on("click",".excel-filter-dlg, .bootstrap-datetimepicker-widget",function(n){n.stopPropagation()});$(document).on("click",function(){var n,t;for(n in f)t=f[n],t.closePopupAndRestoreData()})};this.startLiveScrolling=function(n){e&&(s=0,e.start(n))};this.initStickyHeaderForIe=function(n){if(Webropol.Shared.Common.browser.isIe()&&u.UseStickyHeader())if(Webropol.Common.StickyHeader){var t=n.find(".generic-grid.generic-grid-sticky-header thead"),i=new Webropol.Common.StickyHeader(t);i.init()}else console.warn("sticky-header.js is required to use sticky header in grid for ie")};this.clearAll=function(){o={}}}