var Webropol=Webropol||{};Webropol.Shared=Webropol.Shared||{};Webropol.Shared.ScrollLoader=function(n){var i=this,u=!1,f=!1,r=null,t=null;this.animating=ko.observable(!1);this.toggle=function(n){f=n};this.start=function(n){n===undefined?(r=$(window),t=$(".scroll-loader-container"),$(t).animate({opacity:0})):(r=n,t=$(n).find(".scroll-loader-container"),$(t).animate({opacity:0}));$(r).on("scroll",i.trackScroll);this.toggle(!0)};this.trackScroll=function(){if(f&&!u){var e=$(r)[0],o=e==window?document.body.scrollHeight:e.scrollHeight,s=$(e).scrollTop(),h=$(e).height();if(e==document&&(o=document.body.scrollHeight),o-s<h+25){if(i.animating())return;i.animating(!0);$(t).animate({opacity:1},{duration:500,progress:function(){},done:function(){u=!0;$.when(n()).then(function(){$(t).animate({opacity:0},{duration:500,done:function(){i.animating(!1);u=!1}})})}})}}};this.init=function(){};i.init()};Webropol=Webropol||{};Webropol.Shared=Webropol.Shared||{};Webropol.Shared.ImageGallery=function(n,t,i,r){function c(n){var t={settings:n,callback:function(){n.SaveLogo();u.modalDialog.modal("hide")},canSaveLogo:ko.pureComputed({read:function(){return u.logoClone.AltText()!=null&&u.logoClone.AltText()!==""},deferEvaluation:!0})};ko.shared.showPopupFromTemplate("logo-position-dialog-template",t,null,f.getLogoPositionDialogTemplateUrl)}var u=this,f=n,o=t,s=i,h=r,e=[];u.survey=null;u.sourceImages=null;u.searchText=null;u.scrollLoader=null;u.offset=0;u.pageSize=18;u.ViewMode=ko.observable("Tiles");u.modalDialog=null;u.type=null;u.onImageUseCallback=null;u.selectedImages=null;this.init=function(n,t){u.sourceImages=ko.observableArray([]);u.selectedImages=ko.observableArray([]);u.searchText=ko.observable("");u.type=ko.observable(n);u.onImageUseCallback=t;u.canApplySelected=ko.computed(function(){return u.type()===Webropol.Constants.ImageGalleryMode.MultiAddInOption&&u.selectedImages().length===0?!1:!0})};this.showImageGallery=function(n,t){var i=function(i){u.init(n,t);u.offset=0;u.refreshData("",function(n){n&&ko.mapping.fromJS(n,{},u.sourceImages);var t=ko.shared.showPopupFromTemplate("image-gallery-template",u);u.scrollLoader=new Webropol.Shared.ScrollLoader(u.loadMore);u.scrollLoader.start(t.find(".modal-body"));u.modalDialog=t;$("#searchImages").on("submit",u.onImageSearch);$(".search-clear").on("click",function(){u.searchText("");u.onImageSearch()});i.resolve()},function(){i.reject()})};return $.Deferred(i).promise()};this.showImageGalleryForMultiSelect=function(n,t){u.init(n,t);u.offset=0;u.refreshData("",function(n){n&&ko.mapping.fromJS(n,{},u.sourceImages);var t=ko.shared.showPopupFromTemplate("image-gallery-template",u);u.scrollLoader=new Webropol.Shared.ScrollLoader(u.loadMore);u.scrollLoader.start(t.find(".modal-body"));u.modalDialog=t;$("#searchImages").on("submit",u.onImageSearch);$(".search-clear").on("click",function(){u.searchText("");u.onImageSearch()})})};this.loadMore=function(){var t=u.offset,n;return u.offset+=u.pageSize,n=$.Deferred(),u.refreshData(u.searchText(),function(i){var r,f,e;if(i.length>0)for(r=0,f=i.length;r<f;r++)i[r]&&(e=ko.mapping.fromJS(i[r]),u.sourceImages.push(e));else u.offset=t;n.resolve()},function(){u.offset=t;n.resolve()}),n.promise()};this.refreshData=function(n,t,i){var r=ko.toJSON({searchText:n,offset:u.offset,pageSize:u.pageSize});Webropol.Shared.Common.callAsync(r,f.getImageGallery,function(n){n.ExtraData?t(n.ExtraData):i&&i()},i)};this.onImageSearch=function(){return u.offset=0,u.refreshData(u.searchText(),function(n){ko.mapping.fromJS(n,{},u.sourceImages)}),!1};this.onImagePreview=function(n){ko.utils.arrayForEach(u.sourceImages(),function(n){n.IsActive(!1)});n.IsActive(!0);h.init(u.sourceImages,u.onImageSelected);h.showImageCarousel()};this.onImageSelected=function(n){u.modalDialog.modal("hide");u.onImageUseCallback(n)};this.onToggleImageMarkSelection=function(n){n.IsSelected(!n.IsSelected());n.IsSelected()?u.selectedImages.push(n):u.selectedImages.remove(n)};this.getSelectedImageOrderNumber=function(n){if(u.selectedImages==null||u.selectedImages().length===0)return"";for(var t=0;t<u.selectedImages().length;t++)if(u.selectedImages()[t].ImageId()==n.ImageId())return t+1;return""};this.onApplySelectedImage=function(){var n=u.selectedImages().map(function(n){return n.ImageId()});u.onImageUseCallback(n)};this.LogoSettings=null;this.LogoForThankYouPageSettings=null;this.onBeforeAddAsLogo=function(n){u.logoClone=new Webropol.Template.Logo(f,o,u.LogoSettings.getParent());u.logoClone.init(ko.mapping.toJS(u.LogoSettings));u.logoClone.IsLogoAdded(!0);u.logoClone.Logo=n;u.survey&&!u.survey.IsInstantFeedbackSurvey()?u.logoClone.LogoContainer(Webropol.Constants.Common.Logo.LogoContainerTypes.All):u.logoClone.LogoContainer(Webropol.Constants.Common.Logo.LogoContainerTypes.MainPages);c(u.logoClone)};this.onBeforeAddAsLogoForThankYouPage=function(n){u.logoClone=new Webropol.Template.Logo(f,o,u.LogoForThankYouPageSettings.getParent());u.logoClone.init(ko.mapping.toJS(u.LogoForThankYouPageSettings));u.logoClone.IsLogoAdded(!0);u.logoClone.Logo=n;u.logoClone.LogoContainer(Webropol.Constants.Common.Logo.LogoContainerTypes.ThankYouPage);u.logoClone.LogoPlacement(Webropol.Constants.Common.Logo.Placement.Bottom);c(u.logoClone)};this.onBeforeImageDelete=function(n){ko.shared.showConfirmDialog(o.deleteImageBody,function(){u.deleteImage(n)},function(){},o.deleteImageHeader,o.deleteImageButton)};this.deleteImage=function(n){for(var t=0,i=e.length;t<i;t++)if(e[t]==n.ImageId())return;e.push(n.ImageId());Webropol.Shared.Common.callAsync(JSON.stringify({imageIdToDelete:n.ImageId()}),f.onImageDelete,function(t){if(t.ErrorCode==Webropol.Constants.Common.ErrorCode.Ok)u.sourceImages.remove(function(t){return t.ImageId()==n.ImageId()}),ko.shared.notifySuccess(u,t.Message);else for(var i=0,r=e.length;i<r;i++)if(e[i]==n.ImageId()){e.splice(i,1);break}})};this.shareImage=function(n){var t=!n.IsPublic();Webropol.Shared.Common.callAsync(JSON.stringify({imageId:n.ImageId(),isPublic:t}),f.onImageShare,function(i){i.ErrorCode==Webropol.Constants.Common.ErrorCode.Ok?(n.IsPublic(t),ko.shared.notifySuccess(u,i.Message)):ko.shared.notifyError(u,i.Message)})};this.OnFilesUploaded=function(n){for(var r,t=0,i=n.length;t<i;t++)n[t].ExtraData&&(r=ko.mapping.fromJS(n[t].ExtraData),u.sourceImages.splice(0,0,r))};s.ImagesUploadedCallback=u.OnFilesUploaded;this.showImportImagePopup=function(){s.showImportImagePopup()};this.toggleView=function(n){u.ViewMode(n)};this.imgLoad=function(n,t){var i=t.target;i.width<i.height?$(i).addClass("img-portrait"):$(i).addClass("img-landscape");$(i).closest(".thumbnail-img").find(".thumbnail-loader").hide();$(i).css("opacity",1)};this.imgError=function(n,t){var r=t.target,i=$(r).closest(".thumbnail-img");i.find(".thumbnail-loader").hide();i.find(".thumbnail-error").show()}};Webropol=Webropol||{};Webropol.Shared=Webropol.Shared||{};Webropol.Shared.ImportedImage=function(n){var t=this;this.Guid=n;this.FileName=null;this.Progress=ko.observable(0);this.FileInput=null;this.Data=null;this.FileSize=null;this.FileType=null};Webropol=Webropol||{};Webropol.Shared=Webropol.Shared||{};Webropol.Shared.ImagesImport=function(n,t){var i=this,u=n,f=t,e=window.FormData!==undefined,r=e?new Webropol.Shared.ImagesImportFileApi(i):new Webropol.Shared.ImagesImportIE(i);this.ImportedImages=ko.observableArray();this.UploadingInProgress=ko.observable(!1);this.ImagesUploadedCallback=null;this.ImportPopup=null;this.GetUrls=function(){return u};this.GetMessages=function(){return f};this.QuotaPercentage=ko.computed({deferEvaluation:!0,read:function(){var r=i.UsedQuota(),t=i.TotalQuota(),n;return t?(n=(r/t*100).toFixed(0),n>100&&(n=100),n<0&&(n=0),n):0}});this.QuotaExceeded=ko.computed({deferEvaluation:!0,read:function(){return i.UsedQuota()>i.TotalQuota()}});this.QuotaMessage=ko.computed({deferEvaluation:!0,read:function(){return Webropol.Shared.Common.stringFormat(f.quotaYouHaveUsed,(i.UsedQuota()/1048576).toFixed(2),(i.TotalQuota()/1048576).toFixed(2))}});this.ImportAllowed=ko.computed({deferEvaluation:!0,read:function(){return!i.QuotaExceeded()&&i.ImportedImages().length>0}});this.onUploadImageChanged=function(n){var t=n.target;r.ImportImagesFromInput(t)};this.initializeFileUploader=function(n){var t=function(r){i.onUploadImageChanged(r);var u=$('<input class="images-file-uploader__input" type="file" multiple name="upload"  accept="'+Webropol.Constants.ImageGallery.SupportedImageTypes+'"/>')[0],f=$(n).find(".images-file-uploader__input-container");f.empty();f.append(u);$(u).on("change",t)};$(n).find(".images-file-uploader__input").on("change",t)};this.initializeDndHolder=function(n){var t=$(n).find(".images-drop-holder")[0];if(e){var i=function(n){n.stopPropagation();n.preventDefault();var t=n.eventTarget||n.srcElement;$(t).addClass("hover")},u=function(n){n.stopPropagation();n.preventDefault();var t=n.eventTarget||n.srcElement;$(t).removeClass("hover")},f=function(n){n.stopPropagation();n.preventDefault();var t=n.eventTarget||n.srcElement;$(t).removeClass("hover");n.dataTransfer&&r.ImportImagesFromDataTransfer(n.dataTransfer)};t.removeEventListener("dragover",i);t.removeEventListener("dragleave",u);t.removeEventListener("drop",f);t.addEventListener("dragover",i,!1);t.addEventListener("dragleave",u,!1);t.addEventListener("drop",f,!1)}else $(t).hide(),$(".uploaders-panel__or").hide()};this.reset=function(){i.ImportedImages([]);i.UploadingInProgress(!1);i.ImportPopup=null};this.showImportImagePopup=function(){i.reset();var n=new $.Deferred;Webropol.Shared.Common.callAsync(null,u.getQuotaUrl,function(){}).done(function(t){ko.mapping.fromJS(t,{},i);n.resolve()});n.then(function(){var n=ko.shared.showPopupFromTemplate("import-image-dialog-template",i,function(n){i.initializeFileUploader(n);i.initializeDndHolder(n)});i.ImportPopup=n})};this.uploadImages=function(n,t){r.UploadImages(n,t)};this.deleteImage=function(n){for(var f,o,u,t=0,e=i.ImportedImages().length;t<e;t++)if(i.ImportedImages()[t].Guid==n.Guid){f=i.ImportedImages()[t];o=f.FileSize;i.ImportedImages.splice(t,1);u=i.UsedQuota();u=u-o;u<0&&(u=0);i.UsedQuota(u);r.OnImageDeleted(f);return}};this.imgLoad=function(n,t){var i=t.target;i.width<i.height?$(i).addClass("img-portrait"):$(i).addClass("img-landscape")}};Webropol=Webropol||{};Webropol.Shared=Webropol.Shared||{};Webropol.Shared.ImagesImportFileApi=function(n){var t=n,r=function(n){var u,f,i,r;n&&(u=n.file?n.file.size:0,f=n.file?n.file.name:null,u<=t.MaxImageFileSize()?(i=new Webropol.Shared.ImportedImage(Webropol.Shared.Common.generateGuid()),i.Data=n.data,i.FileName=f,i.FileSize=u,i.FileType=n.file?n.file.type:null,t.ImportedImages.push(i),r=t.UsedQuota(),r=r+i.FileSize,t.UsedQuota(r)):toastr.error(Webropol.Shared.Common.stringFormat(t.GetMessages().quotaMaxImageSizeIsExceeded,f,(t.MaxImageFileSize()/1024).toFixed(0))))},u=function(n){return function(t){r({data:t.target.result,file:n})}},i=function(n){for(var i,r,f,t=0,e=n.length;t<e;t++)n[t]&&(i=n[t],r=i.type,r&&r.indexOf("image/")==0&&(f=new window.FileReader,f.onload=u(i),f.readAsDataURL(i)))},f=function(n,t,i,r,u,f,e){$.ajax({url:i,type:"POST",data:r,dataType:"json",async:!0,global:!1,contentType:"application/json; charset=utf-8",converters:{"text json":Webropol.Shared.Common.parseJSON},xhr:function(){var t=new window.XMLHttpRequest;return t.upload&&t.upload.addEventListener("progress",function(t){if(t.lengthComputable){var i=t.loaded/t.total;e(n,i)}},!1),t},success:function(i){u(n,t,i)},error:function(i,r){f(n,t,i,r)}})};this.ImportImagesFromInput=function(n){n&&n.files&&i(n.files)};this.ImportImagesFromDataTransfer=function(n){n.files&&i(n.files)};this.OnImageDeleted=function(){};this.UploadImages=function(n,i){var e,c,l,o,a;t.UploadingInProgress(!0);var s=[],r=[],h=[],u=t.ImportedImages();for(e=0,c=u.length;e<c;e++)l=u[e],o=new $.Deferred,s.push(o),f(e,o,t.GetUrls().imageUploadUrl,JSON.stringify(l),function(n,t,i){i&&i.ErrorCode==0?h.push(i):(r.push(u[n].FileName),i&&i.Message&&toastr.error(i.Message));t.resolve()},function(n,t){r.push(u[n].FileName);t.resolve()},function(n,t){u[n].Progress((t*100).toFixed(0))});a=function(){var n,u,f;if(t.UploadingInProgress(!1),t.ImportPopup&&$(t.ImportPopup).modal("toggle"),r.length==0)ko.shared.notifySuccess(i.srcElement,t.GetMessages().imagesUploadedSuccessfully);else{for(n="",u=0,f=r.length;u<f;u++)n&&(n+=", "),n+=r[u];n=t.GetMessages().imagesWereFailedToUpload+n;ko.shared.notifyError(i.srcElement,n)}t.ImagesUploadedCallback&&typeof t.ImagesUploadedCallback=="function"&&t.ImagesUploadedCallback(h)};$.when.apply($,s).then(a)}};Webropol=Webropol||{};Webropol.Shared=Webropol.Shared||{};Webropol.Shared.ImagesImportIE=function(n){var t=n,r=function(n){var r,i,u;n&&(r=$(n),r.val()&&(i=new Webropol.Shared.ImportedImage(Webropol.Shared.Common.generateGuid()),u="file"+i.Guid,r.attr("id",u),i.FileName=r.val().replace(/^.*[\\\/]/,""),i.FileInput="#"+u,t.ImportedImages.push(i)))},i;this.ImportImagesFromInput=function(n){var u=$(n),i;u.detach();i=$(Webropol.Shared.Common.stringFormat("<form method='POST' action='{0}' encType='multipart/form-data'><\/form>",t.GetUrls().imageFormUploadUrl));i.append(u);$(".uploaders-panel__inputs-holder").append(i);r(n)};this.ImportImagesFromDataTransfer=function(){};this.OnImageDeleted=function(n){n&&$(n.FileInput).remove()};i=function(n,t,i){return function(r,u,f,e){return i(n,t,r,u,f,e)}};this.UploadImages=function(n,r){var f,a,s,h,o,v,y;t.UploadingInProgress(!0);var c=[],e=[],l=[],u=t.ImportedImages();for(f=0,a=u.length;f<a;f++)s=u[f],s.Progress(1),h=$(s.FileInput),h.length>0&&(o=new $.Deferred,c.push(o),v=$(h).closest("form"),Webropol.Shared.Common.callAjaxSubmit($(v),{success:i(f,o,function(n,t,i){var r=null;try{r=Webropol.Shared.Common.parseJSON(i)}catch(f){}r&&r.ErrorCode==0?l.push(r):(e.push(u[n].FileName),r&&r.Message&&toastr.error(r.Message));u[n].Progress(100);t.resolve()}),error:i(f,o,function(n,t){e.push(u[n].FileName);u[n].Progress(100);t.resolve()})}));y=function(){var n,i,u;if(t.UploadingInProgress(!1),t.ImportPopup&&$(t.ImportPopup).modal("toggle"),e.length==0)ko.shared.notifySuccess(r.srcElement,t.GetMessages().imagesUploadedSuccessfully);else{for(n="",i=0,u=e.length;i<u;i++)n&&(n+=", "),n+=e[i];n=t.GetMessages().imagesWereFailedToUpload+n;ko.shared.notifyError(r.srcElement,n)}t.ImagesUploadedCallback&&typeof t.ImagesUploadedCallback=="function"&&t.ImagesUploadedCallback(l)};$.when.apply($,c).then(y)}};Webropol=Webropol||{};Webropol.Shared=Webropol.Shared||{};Webropol.Shared.ImagesCarousel=function(n,t){var i=this,r=n,u=t;i.images=null;i.onImageUseCallback=null;i.modalDialog=null;this.init=function(n,t){i.images=n;i.onImageUseCallback=t;i.initializeExtraObservables()};this.showImageCarousel=function(){i.modalDialog=ko.shared.showPopupFromTemplate("image-carousel-gallery",i)};this.initializeExtraObservables=function(){i.SelectedImage=ko.computed(function(){if(i.images().length>0){var n=ko.utils.arrayFirst(i.images(),function(n){return n.IsActive()});return n==null&&(n=i.images()[0]),n}return null})};i.onPrevImage=function(){var n=i.images.indexOf(i.SelectedImage());i.SelectedImage().IsActive(!1);n==0?n=i.images().length-1:n==-1?n=0:n--;i.images()[n].IsActive(!0)};i.onNextImage=function(){var n=i.images.indexOf(i.SelectedImage());i.SelectedImage().IsActive(!1);n==i.images().length-1?n=0:n==-1?n=0:n++;i.images()[n].IsActive(!0)};i.onImageSelected=function(){i.modalDialog.modal("hide");i.onImageUseCallback(i.SelectedImage())}}