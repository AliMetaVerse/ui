var Webropol=Webropol||{};Webropol.SurveyPublish=Webropol.SurveyPublish||{};Webropol.SurveyPublish.EmailMessage=Webropol.SurveyPublish.EmailMessage||{};Webropol.SurveyPublish.EmailMessage.RecipientsGrid=function(n,t,i,r,u,f){var e=this,b=n,s=t,k=r,l=u,h=i,d=f,v=null,y=null,p=null,o=ko.observable(!1),c=[],a,w;this.updateModel=function(n){var t={RecipientEmailGrid:{create:function(n){var t={items:{IsSelected:{click:function(){o(!0)}}},columns:{IsSelected:{click:function(){o(!0)}}},requestData:h.data},i={loadDataUrl:h.loadDataUrl};return v=new Webropol.BossTools.GenericGrid(i,s,e,t),v.init(n.data),v}},RecipientGroupsGrid:{create:function(n){var t={items:{IsSelected:{click:function(){o(!0)}}},columns:{IsSelected:{click:function(){o(!0)}}}},i={loadDataUrl:b.getRecipientGroupsGrid};return y=new Webropol.BossTools.GenericGrid(i,s,e,t),y.init(n.data),y}}};ko.mapping.fromJS(n,t,e);e.initializeComputed()};a=function(){var n=p.closest(".popup-wrapper");n.next(".modal-backdrop").remove();n.empty()};this.initializeComputed=function(){e.canApplyRecipientsPopup=ko.pureComputed({read:function(){return o()},deferEvaluation:!0});e.selectedRecipientsText=ko.pureComputed({read:function(){var n=e.RecipientEmailGrid.MultiPagingSelection.SelectedRowIds().length;return n>0?Webropol.Shared.Common.stringFormat(s.selectRecipientsSelectionText,n):s.selectRecipientsNoRecipientsSelected},deferEvaluation:!0});e.AllRecipientsSelected=ko.pureComputed({read:function(){return e.RecipientEmailGrid.MultiPagingSelection.SelectedRowIds().length===e.RecipientEmailGrid.Pager.TotalItemsCount()},deferEvaluation:!0})};this.clearSelection=function(){e.RecipientEmailGrid.clearSelection();o(!0)};this.selectAllRecipients=function(){c.length===0?Webropol.Shared.Common.callAsync({surveyId:d},b.getAllRecipientsIds,function(n){c=c.concat(n);e.RecipientEmailGrid.selectAll(c);o(!0)}):(e.RecipientEmailGrid.selectAll(c),o(!0))};this.applyRecipientsPopup=function(){if(k){var n=[],t=[];e.RecipientEmailGrid.UseMultiPagingSelection()?ko.utils.arrayForEach(e.RecipientEmailGrid.MultiPagingSelection.SelectedRowIds(),function(t){n.push(t)}):ko.utils.arrayForEach(this.RecipientEmailGrid.Items(),function(t){t.IsSelected()&&n.push(t.RecipientId())});ko.utils.arrayForEach(e.RecipientGroupsGrid.Items(),function(n){n.IsSelected()&&t.push(n.RecipientGroupId())});k(n,t);a()}};w=function(){e.RecipientEmailGrid.isDirty()||e.RecipientGroupsGrid.isDirty()?ko.shared.showThreeStateConfirmDialog(s.selectRecipientsUnsavedChangesMessage,function(){e.applyRecipientsPopup()},function(){},function(){l&&l();a()},s.selectRecipientsUnsavedChangesTitle,s.save):(l&&l(),a())};this.showRecipientsGrid=function(){e.RecipientEmailGrid==null?Webropol.Shared.Common.callAsync(ko.mapping.toJSON(h.data),h.url,function(n){e.updateModel(n.Model);$("body").append(n.View);p=ko.shared.showPopupFromTemplate(h.template,e,null,null,null,w,!0)}):(e.RecipientEmailGrid.needToRefresh&&(e.RecipientEmailGrid.reload(),e.RecipientEmailGrid.needToRefresh=!1),e.RecipientGroupsGrid&&e.RecipientGroupsGrid.needToRefresh&&(e.RecipientEmailGrid.reload(),e.RecipientEmailGrid.needToRefresh=!1),p=ko.shared.showPopupFromTemplate(h.template,e,null,null,null,w,!0))}};Webropol=Webropol||{};Webropol.SurveyPublish=Webropol.SurveyPublish||{};Webropol.SurveyPublish.EmailMessage=Webropol.SurveyPublish.EmailMessage||{};Webropol.SurveyPublish.EmailMessage.RecipientsHierarchyGrid=function(n,t,i,r,u,f){var e=this,v=n,y=t,l=r,a=u,o=i,p=f,s=null,w=ko.observable(!1),h,c;this.init=function(i){var r={HierarchyGrid:{create:function(i){var r=new Webropol.SurveyPublish.HierarchySelectionGrid(n,t);return r.init(i.data),r}}};ko.mapping.fromJS(i,r,e);e.initializeComputed()};h=function(){var n=s.closest(".popup-wrapper");n.next(".modal-backdrop").remove();n.empty()};this.initializeComputed=function(){e.canApplyRecipientsPopup=ko.pureComputed(function(){return e.HierarchyGrid.HasSelectedPerson()})};this.applyRecipientsPopup=function(){if(l){var n=[],t=e.HierarchyGrid.getSelectedRecipientIds();ko.utils.arrayForEach(t,function(t){ko.utils.arrayForEach(t,function(t){n.push(t)})});l(n,[]);h()}};c=function(){a&&a();h()};this.showRecipientsGrid=function(){e.RecipientEmailGrid==null?Webropol.Shared.Common.callAsync(ko.mapping.toJSON(o.data),o.url,function(n){e.init(n.Model);$("body").append(n.View);s=ko.shared.showPopupFromTemplate(o.template,e,null,null,null,c,!0)}):s=ko.shared.showPopupFromTemplate(o.template,e,null,null,null,c,!0)}};Webropol=Webropol||{};Webropol.SurveyPublish=Webropol.SurveyPublish||{};Webropol.SurveyPublish.EmailMessage=Webropol.SurveyPublish.EmailMessage||{};Webropol.SurveyPublish.EmailMessage.RecipientsGridCommon=function(n,t,i,r){var s=this,e=n,h=t,o=r,u=i,f=function(){u.SelectedTo(Webropol.Constants.SurveyPublish.EmailSendingMode.Stub)};this.onRecipientsApply=function(n,t){var i={recipientIds:n,recipientGroupIds:t,surveyId:o},r=ko.mapping.toJSON(i);Webropol.Shared.Common.callAsync(r,e.applySelectedRecipients,function(i){u.SelectedRecipients.removeAll();u.SelectedRecipientsEmails.removeAll();n.length===0&&t.length===0?f():i.ExtraData.ResultList.forEach(function(n){u.SelectedRecipients().indexOf(n.RecipientId)===-1&&(u.SelectedRecipients.push(n.RecipientId),u.SelectedRecipientsEmails.push(n.Email))});typeof u.updateEmailRecipientsCountFromSelected=="function"&&u.updateEmailRecipientsCountFromSelected(function(){u.IsEmailRecipientsCountUploaded(!0)});typeof u.updateCircularTargetsCount=="function"&&u.updateCircularTargetsCount();Webropol.Common.showSuccessMessage(i)})};this.onRecipientsCancel=function(){u.SelectedRecipients().length===0&&f()}}